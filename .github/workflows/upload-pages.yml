name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # æŒ‡å®šè§¦å‘åˆ†æ”¯

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # ğŸ‘‡ Build steps
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: npm
      - name: Install dependencies
        run: npm install
      - name: Build
        run: npm run build
      # ğŸ‘† Build steps
      - name: Setup Pages
        uses: actions/configure-pages@v3
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          # ğŸ‘‡ Specify build output path
          path: build
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
      # ğŸ‘‡ Notification steps
      - name: Check blog posts changes
        id: check_blogs
        run: |
          ADDED_BLOGS=$(git diff --diff-filter=A --name-only HEAD^ | grep '^blog/.*\.md$' || true)
          UPDATED_BLOGS=$(git diff --diff-filter=M --name-only HEAD^ | grep '^blog/.*\.md$' || true)
          REMOVED_BLOGS=$(git diff --diff-filter=D --name-only HEAD^ | grep '^blog/.*\.md$' || true)

          if [ -n "$ADDED_BLOGS"]; then
            echo "New blog posts added: $ADDED_BLOGS"
          fi

          if [ -n "$UPDATED_BLOGS"]; then
            echo "Blog posts updated: $UPDATED_BLOGS"
          fi

          if [ -n "$REMOVED_BLOGS"]; then
            echo "Blog posts removed: $REMOVED_BLOGS"
          fi

          echo "added_blogs=$ADDED_BLOGS" >> $GITHUB_ENV
          echo "updated_blogs=$UPDATED_BLOGS" >> $GITHUB_ENV
          echo "removed_blogs=$REMOVED_BLOGS" >> $GITHUB_ENV

          if [ -n "$ADDED_BLOGS" ] || [ -n "$UPDATED_BLOGS" ] || [ -n "$REMOVED_BLOGS" ]; then
            echo "blogs_changed=true" >> $GITHUB_ENV
          else
            echo "blogs_changed=false" >> $GITHUB_ENV
          fi
      - name: Send WeChat notification
        id: send_wechat
        if: env.blogs_changed == 'true'
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          ADDED_BLOGS: ${{ env.added_blogs }}
          UPDATED_BLOGS: ${{ env.updated_blogs }}
          REMOVED_BLOGS: ${{ env.removed_blogs }}
        run: |
          if [ -n "$ADDED_BLOGS" ]; then
            ADDED_LIST=$(echo "$ADDED_BLOGS" | sed 's/^/- /')
          else
            ADDED_LIST="æ— æ–°å¢åšå®¢"
          fi

          if [ -n "$UPDATED_BLOGS" ]; then
            UPDATED_LIST=$(echo "$UPDATED_BLOGS" | sed 's/^/- /')
          else
            UPDATED_LIST="æ— æ›´æ–°åšå®¢"
          fi

          if [ -n "$REMOVED_BLOGS" ]; then
            REMOVED_LIST=$(echo "$REMOVED_BLOGS" | sed 's/^/- /')
          else
            REMOVED_LIST="æ— åˆ é™¤åšå®¢"
          fi

          MESSAGE=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "content": "**ğŸ“¢ åšå®¢å˜æ›´é€šçŸ¥**\n> ä»“åº“: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})\n> åˆ†æ”¯: \`${{ github.ref_name }}\`\n> æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}\n> æ‰§è¡Œè€…: ${{ github.actor }}\n\n**æ–°å¢åšå®¢æ–‡ç« **:\n${ADDED_LIST}\n\n**æ›´æ–°åšå®¢æ–‡ç« **:\n${UPDATED_LIST}\n\næŸ¥çœ‹æ„å»ºè¯¦æƒ…: [Actions Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            }
          }
          EOF
          )

          curl -X POST -H "Content-Type: application/json" -d "$MESSAGE" $WECHAT_WEBHOOK

